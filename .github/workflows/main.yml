name: Build, Test and Push Microservices
on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        microservice: [frontend]
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        ref: ${{github.sha}}

    - name: Load version and build number
      run: |
        export VERSION=1.0.0
        export BUILD_NUMBER=1
# export VERSION=$(grep version ${{ matrix.microservice }}/version.txt | cut -d '=' -f 2)
# export BUILD_NUMBER=$(grep build_number ${{ matrix.microservice }}/version.txt | cut -d '=' -f 2)

    - name: Build, Test and Push all microservice
      run: |
        cd ${{ matrix.microservice }}
        export GIT_SHA=${{github.sha}}
        export TIMESTAMP=$(date +%s)
        docker build -t ${{ matrix.microservice }}:$VERSION_$BUILD_NUMBER_$TIMESTAMP_$GIT_SHA .
        if ! docker run --rm ${{ matrix.microservice }}:$VERSION_$BUILD_NUMBER_$TIMESTAMP_$GIT_SHA pytest; then exit 1; fi